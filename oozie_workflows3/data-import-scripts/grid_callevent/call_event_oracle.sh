#!/bin/bash
server_addr=$1
db_username=$2
db_password=$3

db_table_name="CALL_EVENT"

hbase_namespace="sadan3"
hbase_table_name="call_event"
column_family="basic"


sqoop import -D sqoop.hbase.add.row.key=true --connect ${server_addr} --username ${db_username} --password ${db_password} --query "SELECT '兰州市' as REGION, EVENTCODE, REPLACE(REPLACE(REPLACE(EVENTNAME, CHR(10), ''), CHR(13), ''), CHR(01), '') AS EVENTNAME, CNAME, CTEL, REPLACE(REPLACE(REPLACE(EVENTADDR, CHR(10), ''), CHR(13), ''), CHR(01), '') AS EVENTADDR, EVENTTIME, OCODE, ONAME, CHANNELCODE, CHANNELNAME, TYPEEVENTCODE, TYPEEVENTNAME, CATEGORYCODE, CATEGORYNAME, LEVELNAME, REGIONCODE, REGIONNAME, DELTIME, DELPERSONCODE, DELPERSONNAME, ISTURN, UNCODE, NOTE, STATENAME, STATECODE, REPLACE(REPLACE(REPLACE(CONTENT, CHR(10), ''), CHR(13), ''), CHR(01), '') AS CONTENT, CATEGORYSMALLCODE, CATEGORYSMALLNAME, ANNEXPATH, ANNEXNAME, MOBILE, INVALIDSTATE, EVENT_POINT, RECORD, ISPUBLIC, RANDOMCODE, ISEXCEED, VCODE, VNAME, SMID, ANNEXFILEIDS, CHECKSTATE, REGIONPATH, TURNORGNAME, GEOM, GID, ISURGENTRMD, ISEXCEPTION, MINISATISFACTION, EVALUATE, COMMENTLABEL, ISANONYMOUS, REMIND, ESCAPEEVALUATE, OPINIONTASKID, OPINIONENDTIME, OPINIONDEADLINE FROM ${db_table_name} where \$CONDITIONS " --map-column-java CONTENT=String,GEOM=String   -m 1 --hbase-table ${hbase_namespace}:${hbase_table_name} --column-family ${column_family} --hbase-create-table --hbase-row-key REGION,EVENTCODE

#创建hive外部表
hive -e "CREATE DATABASE IF NOT EXISTS ${hbase_namespace}; 
DROP TABLE IF EXISTS ${hbase_namespace}.${hbase_table_name}; 
CREATE EXTERNAL TABLE ${hbase_namespace}.${hbase_table_name}(HBASE_ROWKEY STRING,EVENTCODE	STRING,EVENTNAME	STRING,CNAME	STRING,CTEL	STRING,EVENTADDR	STRING,EVENTTIME	TIMESTAMP,OCODE	STRING,ONAME	STRING,CHANNELCODE	BIGINT,CHANNELNAME	STRING,TYPEEVENTCODE	BIGINT,TYPEEVENTNAME	STRING,CATEGORYCODE	BIGINT,CATEGORYNAME	STRING,LEVELNAME	STRING,REGIONCODE	BIGINT,REGIONNAME	STRING,DELTIME	TIMESTAMP,DELPERSONCODE	BIGINT,DELPERSONNAME	STRING,ISTURN	BIGINT,UNCODE	BIGINT,NOTE	STRING,STATENAME	STRING,STATECODE	BIGINT,CONTENT	STRING,CATEGORYSMALLCODE	BIGINT,CATEGORYSMALLNAME	STRING,ANNEXPATH	STRING,ANNEXNAME	STRING,MOBILE	STRING,INVALIDSTATE	BIGINT,EVENT_POINT	STRING,RECORD	STRING,ISPUBLIC	STRING,RANDOMCODE	STRING,ISEXCEED	INT,VCODE	BIGINT,VNAME	STRING,SMID	STRING,ANNEXFILEIDS	STRING,CHECKSTATE	BIGINT,REGIONPATH	STRING,TURNORGNAME	STRING,GEOM	STRING,GID	STRING,ISURGENTRMD	BIGINT,ISEXCEPTION	BIGINT,MINISATISFACTION	STRING,EVALUATE	STRING,COMMENTLABEL	STRING,ISANONYMOUS	BIGINT,REMIND	STRING,ESCAPEEVALUATE	STRING,OPINIONTASKID	STRING,OPINIONENDTIME	TIMESTAMP,OPINIONDEADLINE	TIMESTAMP) 
STORED BY 'org.apache.hadoop.hive.hbase.HBaseStorageHandler' 
WITH SERDEPROPERTIES(\"hbase.columns.mapping\"=\":key,${column_family}:EVENTCODE, ${column_family}:EVENTNAME, ${column_family}:CNAME, ${column_family}:CTEL, ${column_family}:EVENTADDR, ${column_family}:EVENTTIME, ${column_family}:OCODE, ${column_family}:ONAME, ${column_family}:CHANNELCODE, ${column_family}:CHANNELNAME, ${column_family}:TYPEEVENTCODE, ${column_family}:TYPEEVENTNAME, ${column_family}:CATEGORYCODE, ${column_family}:CATEGORYNAME, ${column_family}:LEVELNAME, ${column_family}:REGIONCODE, ${column_family}:REGIONNAME, ${column_family}:DELTIME, ${column_family}:DELPERSONCODE, ${column_family}:DELPERSONNAME, ${column_family}:ISTURN, ${column_family}:UNCODE, ${column_family}:NOTE, ${column_family}:STATENAME, ${column_family}:STATECODE, ${column_family}:CONTENT, ${column_family}:CATEGORYSMALLCODE, ${column_family}:CATEGORYSMALLNAME, ${column_family}:ANNEXPATH, ${column_family}:ANNEXNAME, ${column_family}:MOBILE, ${column_family}:INVALIDSTATE, ${column_family}:EVENT_POINT, ${column_family}:RECORD, ${column_family}:ISPUBLIC, ${column_family}:RANDOMCODE, ${column_family}:ISEXCEED, ${column_family}:VCODE, ${column_family}:VNAME, ${column_family}:SMID, ${column_family}:ANNEXFILEIDS, ${column_family}:CHECKSTATE, ${column_family}:REGIONPATH, ${column_family}:TURNORGNAME, ${column_family}:GEOM, ${column_family}:GID, ${column_family}:ISURGENTRMD, ${column_family}:ISEXCEPTION, ${column_family}:MINISATISFACTION, ${column_family}:EVALUATE, ${column_family}:COMMENTLABEL, ${column_family}:ISANONYMOUS, ${column_family}:REMIND, ${column_family}:ESCAPEEVALUATE, ${column_family}:OPINIONTASKID, ${column_family}:OPINIONENDTIME, ${column_family}:OPINIONDEADLINE\") 
TBLPROPERTIES(\"hbase.table.name\" = \"${hbase_namespace}:${hbase_table_name}\")"
